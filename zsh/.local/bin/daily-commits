#!/bin/bash

# Script to crawl all git repositories and show commits with diffs from the past day
# Assuming it is on your $PATH
# Usage: daily-commits

WORK_DIR="$HOME/work"

# Use git's --since with relative time (works on all systems)
SINCE_TIME="24 hours ago"

echo "# Daily Git Activity Summary"
echo "Generated on: $(date)"
echo "Scanning repositories in: $WORK_DIR"
echo "Time range: $SINCE_TIME"
echo ""

# Track if we found any commits
found_commits=false

# Find all .git directories and process their parent directories
find "$WORK_DIR" -name ".git" -type d | while read -r git_dir; do
    repo_dir=$(dirname "$git_dir")
    repo_name=$(basename "$repo_dir")

    cd "$repo_dir" || continue

    # Get commits from the past day
    commits=$(git log --since="$SINCE_TIME" --pretty=format:"%h" --author="$(git config user.name)" 2>/dev/null)

    if [ -n "$commits" ]; then
        found_commits=true
        echo "## Repository: $repo_name"
        echo "**Path:** \`$repo_dir\`"
        echo ""

        # Get commit details and diffs
        while IFS= read -r commit_hash; do
            # Get commit info
            commit_info=$(git show --no-patch --pretty=format:"**%h** - %s (%ar)" "$commit_hash" 2>/dev/null)
            echo "### $commit_info"
            echo ""

            # Get file changes summary
            files_changed=$(git show --name-only --pretty=format:"" "$commit_hash" 2>/dev/null | grep -v '^$')
            if [ -n "$files_changed" ]; then
                echo "**Files changed:**"
                echo '```'
                echo "$files_changed"
                echo '```'
                echo ""
            fi

            # Get diff stats
            diff_stats=$(git show --stat --pretty=format:"" "$commit_hash" 2>/dev/null | grep -v '^$')
            if [ -n "$diff_stats" ]; then
                echo "**Changes:**"
                echo '```'
                echo "$diff_stats"
                echo '```'
                echo ""
            fi

            # Get the actual diff (abbreviated)
            diff_content=$(git show --pretty=format:"" "$commit_hash" 2>/dev/null)
            if [ -n "$diff_content" ]; then
                echo "<details><summary>Show diff</summary>"
                echo ""
                echo '```diff'
                echo "$diff_content"
                echo '```'
                echo "</details>"
                echo ""
            fi

        done <<<"$commits"

        echo "---"
        echo ""
    fi
done

# If no commits found, add a note
if [ "$found_commits" = false ]; then
    echo "No commits found in the past day."
fi

echo ""
echo "*Summary generated by daily-commits*"
